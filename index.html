<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium Video Hub</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- GigaPub Ad -->
<script src="https://ad.gigapub.tech/script?id=1096"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f2f6fa;
  padding:15px 15px 90px;
}
h2{
  text-align:center;
  color:#0088cc;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:12px;
  margin-bottom:15px;
  box-shadow:0 3px 10px rgba(0,0,0,.07);
}
.card img{
  width:100%;
  border-radius:10px;
  height:180px;
  object-fit:cover;
}
.title{
  font-weight:bold;
  margin:10px 0;
}
.progress-bar{
  height:6px;
  background:#eee;
  border-radius:10px;
  overflow:hidden;
}
.progress{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#ff9500,#ffb74d);
}
.btn{
  width:100%;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#0088cc;
  color:#fff;
  font-weight:bold;
  margin-top:10px;
}
.btn.done{
  background:#2ecc71;
}
.loading{
  text-align:center;
  padding:30px;
}
</style>
</head>
<body>

<h2>ðŸ”¥ Premium Video Hub</h2>

<div id="posts">
<div class="loading">Loading Content...</div>
</div>

<script>

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDI2MyfbMFYd6HAkCdZ2A64uNhC16H5Ku4",
  authDomain: "bdvideo-fc2e8.firebaseapp.com",
  databaseURL: "https://bdvideo-fc2e8-default-rtdb.firebaseio.com",
  projectId: "bdvideo-fc2e8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
auth.signInAnonymously();

const tg = window.Telegram?.WebApp;
tg?.expand();
tg?.ready();

let watchedAds = {};

// Load Only Latest 15 Posts (Fast Load)
async function loadPosts(){
  const snap = await db.ref('posts').limitToLast(15).once('value');
  const data = Object.entries(snap.val()||{}).map(([id,p])=>({id,...p})).reverse();
  renderPosts(data);
}

function renderPosts(data){
  const container = document.getElementById("posts");
  container.innerHTML = "";

  data.forEach(p=>{
    const adNeed = p.adCount || 3;
    const watched = watchedAds[p.id] || 0;
    const percent = (watched/adNeed)*100;

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <img src="${p.imageLink || 'https://via.placeholder.com/400x200'}">
      <div class="title">${p.title}</div>
      <div class="progress-bar"><div class="progress" style="width:${percent}%"></div></div>
      <button class="btn ${watched>=adNeed?'done':''}" onclick="watchAd('${p.id}','${p.downloadLink}',${adNeed},this)">
        ${watched>=adNeed?'Watch Now':`Unlock (${watched}/${adNeed})`}
      </button>
    `;
    container.appendChild(div);
  });
}

function watchAd(id, link, adNeed, btn){

  if(!watchedAds[id]) watchedAds[id]=0;

  if(watchedAds[id] >= adNeed){
    window.open(link,'_blank');
    return;
  }

  btn.disabled=true;
  btn.innerText="Loading Ad...";

  window.showGiga()
  .then(()=>{

    watchedAds[id]++;
    const percent = (watchedAds[id]/adNeed)*100;

    btn.parentElement.querySelector(".progress").style.width=percent+"%";

    if(watchedAds[id] >= adNeed){
      btn.innerText="Watch Now";
      btn.classList.add("done");
      tg?.showAlert("Video Unlocked!");
      window.open(link,'_blank');
    }else{
      btn.innerText=`Unlock (${watchedAds[id]}/${adNeed})`;
    }

  })
  .catch(()=>{
    alert("Ad failed. Try again.");
  })
  .finally(()=>{
    btn.disabled=false;
  });
}

auth.onAuthStateChanged(user=>{
  if(user) loadPosts();
});

</script>
</body>
</html>