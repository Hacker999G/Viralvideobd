<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Premium Telegram Mini App</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://alwingulla.com/88/p.js" data-zone="10282897" data-sdk="show_10282897"></script>

    <style>
        :root {
            --bg: #0b0e14;
            --card: #161b22;
            --primary: #0088cc;
            --accent: #ff9500;
            --text: #ffffff;
            --text-dim: #8b949e;
            --success: #238636;
            --radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px 15px 100px;
            background-color: var(--bg);
            color: var(--text);
            user-select: none;
        }

        h2 { font-size: 20px; text-align: center; color: var(--primary); margin-bottom: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        h3 { font-size: 15px; margin: 20px 0 10px; color: var(--text-dim); display: flex; align-items: center; gap: 8px; font-weight: 600; }

        /* Slider */
        #slider { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scroll-snap-type: x mandatory; }
        #slider::-webkit-scrollbar { display: none; }
        .slider-item { 
            min-width: 260px; background: var(--card); border-radius: var(--radius); 
            overflow: hidden; border: 1px solid #30363d; scroll-snap-align: start;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .slider-item img { width: 100%; height: 140px; object-fit: cover; }
        .slider-item .title { padding: 12px; font-weight: 600; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Post Cards */
        .post { background: var(--card); border-radius: var(--radius); padding: 14px; margin-bottom: 18px; border: 1px solid #30363d; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .post img { width: 100%; border-radius: 8px; aspect-ratio: 16/9; object-fit: cover; border: 1px solid #21262d; }
        .post-title { font-weight: 700; margin: 12px 0 6px; font-size: 16px; color: var(--text); }
        .post-description { color: var(--text-dim); font-size: 13px; margin-bottom: 15px; line-height: 1.4; }

        /* Progress & Buttons */
        .progress-bar { height: 6px; background: #21262d; border-radius: 10px; overflow: hidden; margin-bottom: 12px; }
        .progress { height: 100%; background: linear-gradient(90deg, var(--primary), #58a6ff); width: 0%; transition: width 0.5s ease; }

        .buy-button { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            background: linear-gradient(180deg, var(--primary), #0077b5); color: white; 
            font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,136,204,0.2);
        }
        .buy-button.completed { background: linear-gradient(180deg, var(--success), #1e6e2d); box-shadow: 0 4px 10px rgba(35,134,54,0.2); }
        .buy-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .buy-button:active:not(:disabled) { transform: scale(0.96); }

        /* Navigation */
        #bottomMenu { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(22, 27, 34, 0.9); backdrop-filter: blur(15px);
            padding: 15px; display: flex; gap: 10px; overflow-x: auto; 
            border-top: 1px solid #30363d; z-index: 1000;
            justify-content: flex-start;
        }
        #bottomMenu button { 
            background: #21262d; color: var(--text-dim); border: 1px solid #30363d;
            padding: 8px 18px; border-radius: 25px; white-space: nowrap; font-weight: 600;
            font-size: 13px; transition: 0.3s;
        }
        #bottomMenu button.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,136,204,0.4); }

        .loading-text { text-align: center; padding: 40px; color: var(--text-dim); font-style: italic; }
    </style>
</head>
<body>

    <h2 id="welcomeHeader">PREMIUM CONTENT HUB</h2>

    <div id="sliderContainer">
        <h3>ðŸ”¥ Trending Today</h3>
        <div id="slider"><div class="loading-text">Loading trends...</div></div>
    </div>

    <div id="postList">
        <h3>ðŸ“‚ Collections</h3>
        <div class="loading-text">Synchronizing data...</div>
    </div>

    <div id="bottomMenu"></div>

    <script>
        // ---- Firebase Configuration ----
        const firebaseConfig = {
            apiKey: "AIzaSyDI2MyfbMFYd6HAkCdZ2A64uNhC16H5Ku4",
            authDomain: "bdvideo-fc2e8.firebaseapp.com",
            databaseURL: "https://bdvideo-fc2e8-default-rtdb.firebaseio.com",
            projectId: "bdvideo-fc2e8",
            storageBucket: "bdvideo-fc2e8.firebasestorage.app",
            messagingSenderId: "988010505538",
            appId: "1:988010505538:web:e16d6d729ebf98e05294db"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const tg = window.Telegram?.WebApp;
        if(tg) { tg.expand(); tg.ready(); tg.headerColor = '#0b0e14'; }

        let adsWatchedPerPost = {};
        let categories = [];

        function todayKey() { return new Date().toISOString().slice(0, 10); }
        function objToArray(obj) { return Object.entries(obj || {}).map(([id, p]) => ({ id, ...p })); }

        auth.signInAnonymously();

        // --- Ad Logic with Retry Mechanism ---
        async function watchAds(postId, link, adCount, btn) {
            if (!adsWatchedPerPost[postId]) adsWatchedPerPost[postId] = { count: 0 };
            let watched = adsWatchedPerPost[postId].count;

            if (watched >= adCount) {
                window.open(link, '_blank');
                return;
            }

            // à¦¯à¦¦à¦¿ SDK à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à§Ÿ
            if (typeof show_10282897 === 'function') {
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = "â³ Preparing Ad...";

                try {
                    show_10282897().then(async () => {
                        // Success
                        adsWatchedPerPost[postId].count++;
                        updateButtonLabel(btn, adCount, adsWatchedPerPost[postId].count);
                        btn.disabled = false;
                        
                        const user = auth.currentUser;
                        if (user) {
                            await db.ref(`dailyAdsWatched/${todayKey()}/${user.uid}`).transaction(c => (c || 0) + 1);
                        }

                        if (adsWatchedPerPost[postId].count >= adCount) {
                            await db.ref(`postEvents/${todayKey()}/${postId}/${user?.uid || 'anon'}`).set(true);
                            tg.showAlert("Success! Your link is ready.");
                            window.open(link, '_blank');
                        }
                    }).catch(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                        tg.showAlert("Ad was dismissed or failed. Please try again.");
                    });
                } catch (e) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } else {
                // à¦¯à¦¦à¦¿ SDK à¦²à§‹à¦¡ à¦¹à¦¤à§‡ à¦¦à§‡à¦°à¦¿ à¦¹à§Ÿ (à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§à¦•à§à¦°à¦¿à¦¨à¦¶à¦Ÿà§‡à¦° à¦¸à¦®à¦¸à§à¦¯à¦¾à¦Ÿà¦¿ à¦à¦–à¦¾à¦¨à§‡ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡)
                tg.showAlert("Ad System is connecting... Please wait 5 seconds and click again.");
                btn.textContent = "Re-connecting...";
                setTimeout(() => {
                    updateButtonLabel(btn, adCount, adsWatchedPerPost[postId].count);
                }, 5000);
            }
        }

        function updateButtonLabel(button, adCount, watched) {
            const pc = Math.min(100, (watched / adCount) * 100);
            const parent = button.closest('.slider-item, .post');
            const progress = parent.querySelector('.progress');
            if(progress) progress.style.width = pc + '%';

            if (watched >= adCount) {
                button.textContent = "ðŸ”“ Get Link Now";
                button.classList.add("completed");
            } else {
                button.textContent = `Watch Ad to Unlock (${watched}/${adCount})`;
            }
        }

        // --- Content Loaders ---
        async function loadSlider() {
            try {
                const snap = await db.ref('posts').limitToLast(10).once('value');
                const arr = objToArray(snap.val()).reverse().slice(0, 5);
                const sliderEl = document.getElementById('slider');
                sliderEl.innerHTML = '';
                
                arr.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'slider-item';
                    item.innerHTML = `
                        <img src="${p.imageLink || 'https://via.placeholder.com/300x150'}" alt="">
                        <div class="title">${p.title}</div>
                        <div style="padding:0 12px 12px">
                            <div class="progress-bar"><div class="progress"></div></div>
                            <button class="buy-button">Watch Ad (0/${p.adCount || 3})</button>
                        </div>`;
                    sliderEl.appendChild(item);
                    const btn = item.querySelector('button');
                    btn.onclick = () => watchAds(p.id, p.downloadLink, p.adCount || 3, btn);
                });
            } catch(e) { console.error(e); }
        }

        async function loadPosts(catName = null) {
            const listEl = document.getElementById('postList');
            listEl.innerHTML = `<div class="loading-text">Loading ${catName || 'Posts'}...</div>`;
            
            try {
                const snap = await db.ref('posts').once('value');
                let arr = objToArray(snap.val()).reverse();
                if(catName) arr = arr.filter(p => p.category === catName);

                listEl.innerHTML = `<h3>ðŸ“‚ ${catName || 'Recent Posts'}</h3>`;
                if(arr.length === 0) { listEl.innerHTML += '<p style="text-align:center; color:var(--text-dim)">No posts found.</p>'; return; }

                arr.forEach(p => {
                    const post = document.createElement('div');
                    post.className = 'post';
                    post.innerHTML = `
                        <img src="${p.imageLink || 'https://via.placeholder.com/400x200'}" alt="">
                        <div class="post-title">${p.title}</div>
                        <div class="post-description">${p.description || ''}</div>
                        <div class="progress-bar"><div class="progress"></div></div>
                        <button class="buy-button">Watch Ad (0/${p.adCount || 3})</button>`;
                    listEl.appendChild(post);
                    const btn = post.querySelector('button');
                    btn.onclick = () => watchAds(p.id, p.downloadLink, p.adCount || 3, btn);
                });
            } catch(e) { listEl.innerHTML = '<div class="loading-text">Error loading posts.</div>'; }
        }

        async function loadCategories() {
            try {
                const snap = await db.ref('categories').once('value');
                const data = snap.val() || {};
                categories = Object.values(data).map(v => typeof v === 'object' ? v.name : v);
                
                const menu = document.getElementById('bottomMenu');
                menu.innerHTML = '<button class="active">All</button>';
                
                menu.firstChild.onclick = (e) => {
                    document.querySelectorAll('#bottomMenu button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    loadPosts();
                };

                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.textContent = cat;
                    btn.onclick = (e) => {
                        document.querySelectorAll('#bottomMenu button').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        loadPosts(cat);
                    };
                    menu.appendChild(btn);
                });
            } catch(e) { console.error(e); }
        }

        // Initialize
        loadCategories();
        loadSlider();
        loadPosts();
    </script>
</body>
</html>
